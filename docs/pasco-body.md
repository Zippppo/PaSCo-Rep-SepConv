# PaSCo Human Body Adaptation Plan

**Goal:** Migrate PaSCo from autonomous driving to human body scene completion, body data discribtion is located in @Dataset\DATASET_README.md

**Core Principle:** Correct migration first, minimize changes to original PaSCo.

**Key Insight:** PaSCo's sparse convolution architecture is highly parameterized. Most adaptation can be achieved through **data adaptation layer** without touching model internals.

数据格式对比分析
                                                                                                                                                                                                                                                    
  一、相似之处
  ┌──────────┬──────────────────────────┬──────────────────────────┐
  │   方面   │   原始PaSCo (自动驾驶)   │        Body数据集        │
  ├──────────┼──────────────────────────┼──────────────────────────┤
  │ 输入类型 │ 稀疏点云 (LiDAR)         │ 稀疏点云 (体表)          │
  ├──────────┼──────────────────────────┼──────────────────────────┤
  │ 输出类型 │ 稠密3D体素语义标签       │ 稠密3D体素语义标签       │
  ├──────────┼──────────────────────────┼──────────────────────────┤
  │ 任务本质 │ 场景补全 (点云→完整场景) │ 场景补全 (体表→人体内部) │
  ├──────────┼──────────────────────────┼──────────────────────────┤
  │ 存储格式 │ 体素网格 + 边界框        │ 体素网格 + 边界框        │
  ├──────────┼──────────────────────────┼──────────────────────────┤
  │ 坐标系   │ 世界坐标系               │ 世界坐标系               │
  ├──────────┼──────────────────────────┼──────────────────────────┤
  │ 稀疏性   │ 大量empty体素            │ 大量空点 (~50-90%)       │
  └──────────┴──────────────────────────┴──────────────────────────┘
  核心相似点：两者都是 稀疏输入 → 稠密输出 的场景补全任务。

  ---
  二、关键差异
  ┌────────────┬────────────────────────────────────┬───────────────────────────────────────────┬──────────────────────┐
  │    方面    │             原始PaSCo              │                Body数据集                 │         影响         │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 体素分辨率 │ 0.2m (20cm)                        │ 4mm                                       │ 相差50倍，Body更精细 │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 网格尺寸   │ 固定 256×256×32                    │ 动态 (D,H,W)                              │ 需要处理变尺寸       │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 场景尺寸   │ 固定 51.2×51.2×6.4m                │ 动态                                      │ collate需修改        │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 类别数     │ 20类                               │ 72类                                      │ 模型输出维度变化     │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 空点定义   │ class 0 = empty                    │ class 0 = outside, class 1 = inside_empty │ 需区分体内外空点     │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 输入特征   │ xyz + intensity + vote + embedding │ 仅xyz                                     │ 输入特征维度大幅简化 │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 实例标签   │ 有 (thing类)                       │ 无                                        │ 可简化MIMO策略       │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 坐标单位   │ 米 (m)                             │ 毫米 (mm)                                 │ 数值范围差异         │
  ├────────────┼────────────────────────────────────┼───────────────────────────────────────────┼──────────────────────┤
  │ 预处理     │ WaffleIron特征提取                 │ 无                                        │ 无需复杂预处理       │
  └────────────┴────────────────────────────────────┴───────────────────────────────────────────┴──────────────────────┘

  三、迁移时的核心挑战
  1. 动态网格尺寸：原PaSCo假设固定256³，需要修改collate函数支持batch内不同尺寸
  2. 输入特征简化：Body只有xyz，无预训练特征。两种路线：
    - (a) 直接用xyz + 位置编码
    - (b) 先训练一个体表特征提取器
  3. 类别不平衡加剧：72类 vs 20类，且器官体素仅占10-15%
  4. 无实例标签：原PaSCo的thing/stuff分离、实例级MIMO可能需要简化
  5. 空点语义：需要模型学习区分 outside_body 和 inside_body_empty

实现思路总结                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  1. 固定网格尺寸
                                                                                                                                                                                                                                                      策略：统计 → 确定固定尺寸 → Padding/Crop
                                                                                                                                                                                                                                                    
  步骤：
  (a) 统计4028样本的(D,H,W)分布，找到覆盖95%+的尺寸
  (b) 选定固定尺寸，如 128×128×256 或 256×256×128
  (c) 小样本padding（填充class 0），大样本居中crop

  优先级：高 - 这是基础设施

  ---
  2. 实例标签构造

  策略：基于解剖学先验，对成对/多实例器官分配实例ID

  候选器官：
  - 肋骨 (rib_left_1~12, rib_right_1~12) → 24个实例
  - 肾脏 (kidney_left, kidney_right) → 2个实例
  - 肺 (lung_left, lung_right) → 2个实例
  - 椎骨 (vertebrae) → 多个实例

    优势：
  ┌──────────────────────────────────────────────┐
  │ 1. 特征共享：所有肋骨共同学习"肋骨纹理/形状"    │
  │ 2. 样本平衡：rib类别获得24倍训练样本           │
  │ 3. 泛化能力：模型理解器官本质，而非死记位置     │
  │ 4. 符合PaSCo设计：充分利用Mask-centric架构     │
  └────────────────────────────────────────────────
  优先级：中 - 先跑通基础版本，再加实例

  ---
  3. 点云特征编码器

  策略：预训练一个encoder，将(N,3) → (N,D)

  两阶段方案：
  Stage 1: 自监督预训练
    - 任务：体表点云重建 / 对比学习
    - 输出：点级特征 (N, 256)

  Stage 2: 端到端微调
    - 将encoder接入PaSCo主干
    - 联合训练或冻结encoder

  备选：直接用PointNet++/sparse conv作为encoder，端到端训练

  优先级：高 - 输入特征质量直接影响性能

  ---
  4. 空气类别合并

  策略：最简单，直接映射

  # 数据加载时
  voxel_labels[voxel_labels == 1] = 0  # inside_empty → outside
  # 类别数：72 → 71

  优先级：低 - 一行代码解决